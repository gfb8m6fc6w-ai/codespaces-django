"""
API REST باستخدام FastAPI
"""

from fastapi import FastAPI, HTTPException, File, UploadFile\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.responses import JSONResponse\nfrom typing import List, Optional\nimport json\nfrom pathlib import Path\nimport sys\n\n# إضافة مسار المشروع\nsys.path.insert(0, str(Path(__file__).parent.parent))\n\nfrom billiards.engine import BilliardsEngine\nfrom billiards.calculator import ShotCalculator\nfrom models.shot import Shot, Difficulty\n\n# إنشاء تطبيق FastAPI\napp = FastAPI(\n    title=\"5A Diamond System Pro API\",\n    description=\"API لتطبيق نظام البلياردو الاحترافي\",\n    version=\"1.0.0\",\n)\n\n# إضافة CORS\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# تهيئة محرك البلياردو\nengine = BilliardsEngine()\ncalculator = ShotCalculator()\n\n\n# ==========================================\n# المسارات الأساسية\n# ==========================================\n\n@app.get(\"/\")\nasync def root():\n    \"\"\"المسار الرئيسي\"\"\"\n    return {\n        \"message\": \"مرحباً بك في 5A Diamond System Pro API\",\n        \"version\": \"1.0.0\",\n        \"endpoints\": {\n            \"health\": \"/health\",\n            \"calculate\": \"/api/v1/calculate\",\n            \"statistics\": \"/api/v1/statistics\",\n            \"shots\": \"/api/v1/shots\",\n        }\n    }\n\n\n@app.get(\"/health\")\nasync def health_check():\n    \"\"\"فحص صحة الخادم\"\"\"\n    return {\n        \"status\": \"healthy\",\n        \"total_shots\": len(engine.shots),\n        \"total_calculations\": engine.statistics.total_calculations,\n    }\n\n\n# ==========================================\n# حساب التسديقات\n# ==========================================\n\n@app.post(\"/api/v1/calculate\")\nasync def calculate_shot(\n    rails: int,\n    cue_position: float,\n    white_ball: float,\n    target: float,\n    pocket: int,\n):\n    \"\"\"\n    حساب تسديقة جديدة\n    \n    Parameters:\n    - rails: عدد الجدران (1-4)\n    - cue_position: موضع العصا\n    - white_ball: موضع الكرة البيضاء\n    - target: موضع الهدف\n    - pocket: موضع الجيب المستهدف\n    \"\"\"\n    try:\n        shot = engine.calculate_shot(rails, cue_position, white_ball, target, pocket)\n        summary = calculator.get_calculation_summary(shot)\n        engine.save_to_storage()\n        \n        return {\n            \"success\": True,\n            \"shot\": shot.to_dict(),\n            \"summary\": summary,\n        }\n    except ValueError as e:\n        raise HTTPException(status_code=400, detail=str(e))\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n\n\n# ==========================================\n# إدارة التسديقات\n# ==========================================\n\n@app.get(\"/api/v1/shots\")\nasync def get_shots(rails: Optional[int] = None, difficulty: Optional[str] = None):\n    \"\"\"\n    الحصول على قائمة التسديقات\n    \n    Parameters:\n    - rails: تصفية حسب عدد الجدران (اختياري)\n    - difficulty: تصفية حسب مستوى الصعوبة (اختياري)\n    \"\"\"\n    shots = engine.shots\n    \n    if rails:\n        shots = [s for s in shots if s.rails == rails]\n    \n    if difficulty:\n        shots = [s for s in shots if s.difficulty.value == difficulty]\n    \n    return {\n        \"total\": len(shots),\n        \"shots\": [s.to_dict() for s in shots],\n    }\n\n\n@app.get(\"/api/v1/shots/{shot_id}\")\nasync def get_shot_by_id(shot_id: int):\n    \"\"\"\n    الحصول على تسديقة محددة\n    \"\"\"\n    if shot_id < 0 or shot_id >= len(engine.shots):\n        raise HTTPException(status_code=404, detail=\"لم يتم العثور على التسديقة\")\n    \n    return engine.shots[shot_id].to_dict()\n\n\n@app.post(\"/api/v1/shots/{shot_id}/record\")\nasync def record_shot_execution(shot_id: int, successful: bool):\n    \"\"\"\n    تسجيل نتيجة تنفيذ تسديقة\n    \"\"\"\n    try:\n        if shot_id < 0 or shot_id >= len(engine.shots):\n            raise HTTPException(status_code=404, detail=\"لم يتم العثور على التسديقة\")\n        \n        shot = engine.shots[shot_id]\n        engine.record_execution(shot, successful)\n        \n        return {\n            \"success\": True,\n            \"message\": \"تم تسجيل النتيجة\",\n            \"shot\": shot.to_dict(),\n        }\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n\n\n# ==========================================\n# الإحصائيات\n# ==========================================\n\n@app.get(\"/api/v1/statistics\")\nasync def get_statistics():\n    \"\"\"\n    الحصول على الإحصائيات الكاملة\n    \"\"\"\n    return engine.get_statistics()\n\n\n@app.get(\"/api/v1/statistics/by-rails\")\nasync def get_statistics_by_rails():\n    \"\"\"\n    الإحصائيات حسب عدد الجدران\n    \"\"\"\n    stats = {}\n    for rails in [1, 2, 3, 4]:\n        shots = engine.get_shots_by_rails(rails)\n        if shots:\n            successful = sum(1 for s in shots if s.executed and s.result)\n            stats[f\"rails_{rails}\"] = {\n                \"total\": len(shots),\n                \"successful\": successful,\n                \"success_rate\": (successful / len(shots)) * 100 if shots else 0,\n            }\n    \n    return stats\n\n\n# ==========================================\n# استيراد وتصدير البيانات\n# ==========================================\n\n@app.post(\"/api/v1/export\")\nasync def export_data():\n    \"\"\"\n    تصدير جميع البيانات\n    \"\"\"\n    return {\n        \"shots\": [s.to_dict() for s in engine.shots],\n        \"statistics\": engine.get_statistics(),\n    }\n\n\n@app.post(\"/api/v1/import\")\nasync def import_data(file: UploadFile = File(...)):\n    \"\"\"\n    استيراد البيانات من ملف JSON\n    \"\"\"\n    try:\n        content = await file.read()\n        data = json.loads(content.decode('utf-8'))\n        \n        # مسح البيانات الحالية\n        engine.shots = []\n        \n        # استيراد التسديقات\n        if 'shots' in data:\n            for shot_data in data['shots']:\n                engine.shots.append(Shot.from_dict(shot_data))\n        \n        engine.save_to_storage()\n        \n        return {\n            \"success\": True,\n            \"message\": f\"تم استيراد {len(engine.shots)} تسديقة\",\n        }\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n\nif __name__ == \"__main__\":\n    import uvicorn\n    uvicorn.run(app, host=\"0.0.0.0\", port=8001)\n"