"""
محرك البلياردو الرئيسي
"""

from typing import List, Optional, Dict
from .calculator import ShotCalculator
from .rail_system import RailPositionsSystem
from ..models.shot import Shot, ShotStatistics
from ..models.statistics import Statistics
import json
from pathlib import Path
from functools import lru_cache
import logging

logger = logging.getLogger(__name__)\n\n\nclass BilliardsEngine:\n    \"\"\"\n    محرك البلياردو الرئيسي - يجمع جميع الأنظمة الفرعية\n    \"\"\"\n    \n    def __init__(self, data_dir: Optional[str] = None):\n        \"\"\"\n        تهيئة محرك البلياردو\n        \n        Args:\n            data_dir: مسار مجلد البيانات (اختياري)\n        \"\"\"\n        self.calculator = ShotCalculator()\n        self.rail_system = RailPositionsSystem()\n        self.shots: List[Shot] = []\n        self.statistics = Statistics()\n        \n        # مسار البيانات\n        if data_dir:\n            self.data_dir = Path(data_dir)\n            self.data_dir.mkdir(parents=True, exist_ok=True)\n        else:\n            self.data_dir = Path.home() / \".billiards_pro\"\n            self.data_dir.mkdir(parents=True, exist_ok=True)\n        \n        self.shots_file = self.data_dir / \"shots.json\"\n        self.stats_file = self.data_dir / \"statistics.json\"\n        \n        # تحميل البيانات الموجودة\n        self.load_from_storage()\n    \n    def calculate_shot(self, rails: int, cue_position: float, white_ball: float,\n                      target: float, pocket: int) -> Shot:\n        \"\"\"\n        حساب وإنشاء تسديقة جديدة\n        \n        Args:\n            rails: عدد الجدران (1-4)\n            cue_position: موضع العصا\n            white_ball: موضع الكرة البيضاء\n            target: موضع الهدف\n            pocket: موضع الجيب المستهدف\n        \n        Returns:\n            كائن التسديقة المحسوب\n        \"\"\"\n        shot = self.calculator.create_shot(rails, cue_position, white_ball, target, pocket)\n        self.shots.append(shot)\n        self.statistics.total_calculations += 1\n        return shot\n    \n    def record_execution(self, shot: Shot, successful: bool) -> None:\n        \"\"\"\n        تسجيل نتيجة تنفيذ التسديقة\n        \n        Args:\n            shot: التسديقة\n            successful: هل كانت ناجحة؟\n        \"\"\"\n        shot.executed = True\n        self.statistics.total_shots_attempted += 1\n        \n        if successful:\n            self.statistics.total_shots_successful += 1\n        \n        self.save_to_storage()\n    \n    def get_shots_by_difficulty(self, difficulty: str) -> List[Shot]:\n        \"\"\"\n        الحصول على التسديقات حسب مستوى الصعوبة\n        \n        Args:\n            difficulty: مستوى الصعوبة\n        \n        Returns:\n            قائمة التسديقات\n        \"\"\"\n        return [s for s in self.shots if s.difficulty.value == difficulty]\n    \n    def get_shots_by_rails(self, rails: int) -> List[Shot]:\n        \"\"\"\n        الحصول على التسديقات حسب عدد الجدران\n        \n        Args:\n            rails: عدد الجدران\n        \n        Returns:\n            قائمة التسديقات\n        \"\"\"\n        return [s for s in self.shots if s.rails == rails]\n    \n    def get_statistics(self) -> Dict:\n        \"\"\"\n        الحصول على الإحصائيات الكاملة\n        \n        Returns:\n            قاموس بالإحصائيات\n        \"\"\"\n        return self.statistics.to_dict()\n    \n    def save_to_storage(self) -> None:\n        \"\"\"\n        حفظ البيانات في التخزين\n        \"\"\"\n        # حفظ التسديقات\n        shots_data = [s.to_dict() for s in self.shots]\n        with open(self.shots_file, 'w', encoding='utf-8') as f:\n            json.dump(shots_data, f, ensure_ascii=False, indent=2)\n        \n        # حفظ الإحصائيات\n        with open(self.stats_file, 'w', encoding='utf-8') as f:\n            json.dump(self.statistics.to_dict(), f, ensure_ascii=False, indent=2)\n    \n    def load_from_storage(self) -> None:\n        \"\"\"\n        تحميل البيانات من التخزين\n        \"\"\"\n        # تحميل التسديقات\n        if self.shots_file.exists():\n            with open(self.shots_file, 'r', encoding='utf-8') as f:\n                try:\n                    shots_data = json.load(f)\n                    self.shots = [Shot.from_dict(s) for s in shots_data]\n                except json.JSONDecodeError:\n                    self.shots = []\n        \n        # تحميل الإحصائيات\n        if self.stats_file.exists():\n            with open(self.stats_file, 'r', encoding='utf-8') as f:\n                try:\n                    stats_data = json.load(f)\n                    # يمكن تحديث الإحصائيات من الملف هنا\n                except json.JSONDecodeError:\n                    pass\n"