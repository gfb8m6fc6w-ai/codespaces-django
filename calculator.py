"""
حاسبة التسديقات
"""

from typing import Optional, Dict
from ..models.shot import Shot, Difficulty
from .rail_system import RailPositionsSystem
import math
from functools import lru_cache


class ShotCalculator:
    \"\"\"\n    حساب معاملات التسديقة والصعوبة والقوة\n    \"\"\"\n    \n    def __init__(self):\n        self.rail_system = RailPositionsSystem()\n    \n    def calculate_cue(self, target: float, white_ball: float) -> float:\n        \"\"\"\n        حساب قيمة العصا\n        الصيغة: Cue = Target + White Ball\n        \n        Args:\n            target: قيمة الهدف\n            white_ball: قيمة الكرة البيضاء\n        \n        Returns:\n            قيمة العصا المحسوبة\n        \"\"\"\n        cue = target + white_ball\n        \n        # تقريب إلى رقم عشري واحد\n        return round(cue, 1)\n    \n    def calculate_difficulty(self, rails: int, target_distance: float, \n                           white_ball_distance: float) -> Difficulty:\n        \"\"\"\n        حساب مستوى الصعوبة بناءً على عدد الجدران والمسافات\n        \n        Args:\n            rails: عدد الجدران (1-4)\n            target_distance: مسافة الهدف\n            white_ball_distance: مسافة الكرة البيضاء\n        \n        Returns:\n            مستوى الصعوبة\n        \"\"\"\n        base_difficulty = 30\n        \n        # إضافة الصعوبة بناءً على عدد الجدران\n        difficulty_score = base_difficulty + (rails - 1) * 20\n        \n        # إضافة الصعوبة بناءً على المسافة\n        max_distance = 8.0\n        distance_factor = (max(target_distance, white_ball_distance) / max_distance) * 20\n        difficulty_score += distance_factor\n        \n        # تحديد مستوى الصعوبة\n        if difficulty_score < 40:\n            return Difficulty.EASY\n        elif difficulty_score < 60:\n            return Difficulty.MEDIUM\n        elif difficulty_score < 80:\n            return Difficulty.HARD\n        elif difficulty_score < 100:\n            return Difficulty.VERY_HARD\n        else:\n            return Difficulty.EXTREME\n    \n    def calculate_success_rate(self, rails: int, difficulty: Difficulty) -> float:\n        \"\"\"\n        حساب معدل النجاح المتوقع\n        \n        Args:\n            rails: عدد الجدران\n            difficulty: مستوى الصعوبة\n        \n        Returns:\n            معدل النجاح (0-100)\n        \"\"\"\n        # معدل النجاح الأساسي\n        base_rates = {\n            Difficulty.EASY: 90,\n            Difficulty.MEDIUM: 70,\n            Difficulty.HARD: 50,\n            Difficulty.VERY_HARD: 30,\n            Difficulty.EXTREME: 10,\n        }\n        \n        rate = base_rates.get(difficulty, 50)\n        \n        # تقليل المعدل بناءً على عدد الجدران\n        rails_penalty = (rails - 1) * 5\n        rate = max(5, rate - rails_penalty)\n        \n        return float(rate)\n    \n    def calculate_power_required(self, rails: int, white_ball: float, \n                                target: float) -> float:\n        \"\"\"\n        حساب القوة المطلوبة للتسديقة\n        \n        Args:\n            rails: عدد الجدران\n            white_ball: قيمة الكرة البيضاء\n            target: قيمة الهدف\n        \n        Returns:\n            القوة المطلوبة (0-100)\n        \"\"\"\n        # الصيغة الأساسية\n        power = 50 + (white_ball * 2) + (target * 1.5)\n        \n        # تضاعيف الجدران\n        power *= (1 + (rails - 1) * 0.2)\n        \n        # تقييد النتيجة\n        return min(100, max(10, power))\n    \n    def calculate_angle_required(self, cue: float, white_ball: float) -> float:\n        \"\"\"\n        حساب الزاوية المطلوبة\n        \n        Args:\n            cue: قيمة العصا\n            white_ball: قيمة الكرة البيضاء\n        \n        Returns:\n            الزاوية بالدرجات\n        \"\"\"\n        # تحويل القيم إلى زاوية\n        angle = (cue * 18) % 180  # 180 درجة كأقصى زاوية\n        return float(angle)\n    \n    def create_shot(self, rails: int, cue_position: float, white_ball: float,\n                   target: float, pocket: int) -> Shot:\n        \"\"\"\n        إنشاء تسديقة محسوبة كاملة\n        \n        Args:\n            rails: عدد الجدران\n            cue_position: موضع العصا\n            white_ball: موضع الكرة البيضاء\n            target: موضع الهدف\n            pocket: موضع الجيب\n        \n        Returns:\n            كائن التسديقة المحسوب\n        \"\"\"\n        cue = self.calculate_cue(target, white_ball)\n        difficulty = self.calculate_difficulty(rails, target, white_ball)\n        success_rate = self.calculate_success_rate(rails, difficulty)\n        \n        return Shot(\n            rails=rails,\n            cue_position=cue_position,\n            white_ball=white_ball,\n            target=target,\n            pocket=pocket,\n            difficulty=difficulty,\n            success_rate=success_rate,\n        )\n    \n    def get_calculation_summary(self, shot: Shot) -> dict:\n        \"\"\"\n        الحصول على ملخص حسابات التسديقة\n        \n        Args:\n            shot: التسديقة\n        \n        Returns:\n            قاموس بالحسابات\n        \"\"\"\n        cue = self.calculate_cue(shot.target, shot.white_ball)\n        power = self.calculate_power_required(shot.rails, shot.white_ball, shot.target)\n        angle = self.calculate_angle_required(cue, shot.white_ball)\n        \n        return {\n            'cue_value': cue,\n            'power_required': power,\n            'angle_required': angle,\n            'difficulty': shot.difficulty.value,\n            'success_rate': shot.success_rate,\n            'rails': shot.rails,\n            'pocket': shot.pocket,\n        }\n"